<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="StudentDashBoard.css" />
</head>
<body>
  <!-- Top Navbar -->
  <header class="top-nav">
    <div class="brand">College DBMS • Student Dashboard</div>
    <div class="nav-right">
      <div class="user">Logged in as: <strong>student@example.edu</strong></div>
      <button id="logout-btn" class="btn-logout">Logout</button>
    </div>
  </header>

  <main class="page">
    <!-- Student Profile / My Info -->
    <section class="card" id="my-info">
      <h2>My Profile</h2>
      <div class="info-grid">
        <div class="info-item">
          <label>Name</label>
          <span id="student-name" class="placeholder-text">Loading...</span>
        </div>
        <div class="info-item">
          <label>Major</label>
          <span id="student-major" class="placeholder-text">Loading...</span>
        </div>
        <div class="info-item">
          <label>Cumulative GPA</label>
          <span id="student-gpa" class="placeholder-text">Loading...</span>
        </div>
        <div class="info-item">
          <label>Advisor</label>
          <span id="student-advisor" class="placeholder-text">Loading...</span>
        </div>
      </div>
      <p class="tiny-text">
        * This section will automatically populate once the backend connection is established.
      </p>
    </section>

    <!-- Enrolled Courses / CRUD -->
    <section class="card" id="my-courses">
      <h2>My Enrolled Sections</h2>

      <!-- CREATE: Add new enrollment -->
      <div class="card">
  <h2>Add Enrollment</h2>

  <form id="enroll-form">
    <div class="form-grid">
      <input
        type="text"
        id="add-course-code"
        placeholder="Course Code (e.g., MATH 164)"
        required
      />
      <input
        type="number"
        id="add-section-number"
        placeholder="Section Number"
        min="1"
        required
      />
      <input
        type="text"
        id="add-term-name"
        placeholder="Term Name (e.g., Fall 2025)"
        required
      />
    </div>

    <button type="submit" class="btn">Add Enrollment</button>
  </form>
</div>


      <!-- SEARCH: filter local data -->
      <div class="search-row">
        <input
          type="text"
          id="courseSearch"
          placeholder="Search enrolled courses (e.g., MATH 164, Fall 2025)"
        />
        <button type="button" id="courseSearchBtn" class="btn btn-outline">
          Search
        </button>
      </div>

      <!-- READ: results container -->
      <div id="course-results" class="results-wrapper" style="display: none;">
        <p id="course-count" class="tiny-text"></p>
        <div class="table-wrapper">
          <table id="course-table">
            <thead>
              <tr>
                <th>Course Code</th>
                <th>Title</th>
                <th>Section</th>
                <th>Term</th>
                <th>Instructor</th>
                <th>Capacity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- rows added by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- message area for “no results” -->
      <p id="course-empty" class="tiny-text" style="display: none;">
        No matching courses found. Try “MATH 164” or “Fall 2025”.
      </p>
    </section>
  </main>

  <!-- Script for Logout and CRUD logic -->
<script>
const API_BASE = "http://127.0.0.1:5000";

document.addEventListener("DOMContentLoaded", () => {
  // ---------------------------
  // 0) Check logged-in user
  // ---------------------------
  const rawUser = localStorage.getItem("dbms_user");
  if (!rawUser) {
    alert("Please log in first.");
    window.location.href = "LoginPage.html";
    return;
  }

  const user = JSON.parse(rawUser);
  const userEmail = user.email;

  // Put email in the navbar
  const userLabel = document.querySelector(".user strong");
  if (userLabel) userLabel.textContent = userEmail;

  // ---------------------------
  // 1) Logout
  // ---------------------------
  document.getElementById("logout-btn")?.addEventListener("click", () => {
    localStorage.removeItem("dbms_user");
    window.location.href = "LoginPage.html";
  });

  // ---------------------------
  // 2) Load Profile
  // ---------------------------
  function loadProfile() {
    fetch(`${API_BASE}/api/student/me?email=${encodeURIComponent(userEmail)}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("student-name").textContent =
          `${data.fname} ${data.lname}`;
        document.getElementById("student-major").textContent = data.major;
        document.getElementById("student-gpa").textContent = data.gpa;
        document.getElementById("student-advisor").textContent =
          data.advisor_name || "N/A";
      });
  }

  // ---------------------------
  // 3) Load Enrolled Courses
  // ---------------------------
  let allCourses = [];
  const tableBody = document.querySelector("#course-table tbody");

  function renderCourses(list) {
    tableBody.innerHTML = "";
    list.forEach((c) => {
      const instr = `${c.instr_fname || ""} ${c.instr_lname || ""}`.trim();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.course_code}</td>
        <td>${c.course_title}</td>
        <td>${c.section_number}</td>
        <td>${c.term_name}</td>
        <td>${instr || "TBA"}</td>
        <td>${c.capacity}</td>
        <td><button class="btn drop-btn" data-id="${c.section_id}">Drop</button></td>
      `;
      tableBody.appendChild(tr);
    });
  }

  function loadCourses() {
    fetch(`${API_BASE}/api/student/courses?email=${encodeURIComponent(userEmail)}`)
      .then(res => res.json())
      .then(rows => {
        allCourses = rows || [];
        renderCourses(allCourses);
      });
  }

  // ---------------------------
  // 4) CREATE Enrollment (FIXED)
  // ---------------------------
  const enrollForm = document.getElementById("enroll-form");

  enrollForm.addEventListener("submit", (e) => {
    e.preventDefault();

    const course_code = document.getElementById("add-course-code").value.trim();
    const section_number = document.getElementById("add-section-number").value.trim();
    const term_name = document.getElementById("add-term-name").value.trim();

    if (!course_code || !section_number || !term_name) {
      alert("Please fill in Course Code, Section Number, and Term.");
      return;
    }

    const body = {
      course_code,
      section_number,
      term_name
    };

    fetch(`${API_BASE}/api/student/courses?email=${encodeURIComponent(userEmail)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    })
      .then(res => res.json().then(data => ({ ok: res.ok, data })))
      .then(({ ok, data }) => {
        if (!ok) {
          alert(data.message || "Could not add enrollment.");
          return;
        }
        alert("Enrollment added successfully.");
        allCourses.push(data);
        renderCourses(allCourses);
        enrollForm.reset();
      })
      .catch(err => {
        console.error(err);
        alert("Error adding enrollment.");
      });
  });

// ---------------------------
// 5) DELETE Enrollment
// ---------------------------

tableBody.addEventListener("click", (e) => {
  const btn = e.target.closest(".drop-btn");
  if (!btn) return;

  const sectionId = btn.dataset.id;

  if (!confirm("Are you sure you want to drop this course?")) {
    return;
  }

  fetch(`${API_BASE}/api/student/courses/${sectionId}?email=${encodeURIComponent(userEmail)}`, {
    method: "DELETE",
  })
    .then((res) => res.json().then((data) => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
      if (!ok) {
        alert(data.message || "Could not drop enrollment.");
        return;
      }

      alert("Enrollment dropped.");
      // remove from local array and re-render
      allCourses = allCourses.filter(
        (c) => String(c.section_id) !== String(sectionId)
      );
      renderCourses(allCourses);
    })
    .catch((err) => {
      console.error(err);
      alert("Error dropping enrollment.");
    });
});


// ---------------------------
// 6) SEARCH enrolled courses
// ---------------------------
const searchInput = document.getElementById("courseSearch");
const searchBtn = document.getElementById("courseSearchBtn");
const courseResults = document.getElementById("course-results");
const emptyMessage = document.getElementById("course-empty");
const countLabel = document.getElementById("course-count");

function runSearch() {
  const q = searchInput.value.trim().toLowerCase();

  if (!q) {
    // If search is empty → show everything
    renderCourses(allCourses);
    courseResults.style.display = "block";
    emptyMessage.style.display = "none";
    countLabel.textContent = `${allCourses.length} enrolled section(s)`;
    return;
  }

  const filtered = allCourses.filter(c =>
    c.course_code.toLowerCase().includes(q) ||
    c.course_title.toLowerCase().includes(q) ||
    c.term_name.toLowerCase().includes(q)
  );

  if (filtered.length === 0) {
    tableBody.innerHTML = "";
    courseResults.style.display = "none";
    emptyMessage.style.display = "block";
    emptyMessage.textContent = "No matching courses found.";
    return;
  }

  emptyMessage.style.display = "none";
  courseResults.style.display = "block";

  renderCourses(filtered);
  countLabel.textContent = `${filtered.length} matching course(s)`;
}

// Button click
searchBtn.addEventListener("click", runSearch);

// Pressing ENTER runs search
searchInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    runSearch();
  }
});


  // Initial load
  loadProfile();
  loadCourses();
});
</script>

</body>
</html>
